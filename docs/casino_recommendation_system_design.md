# Kessbet Casino 推荐系统设计方案

## 1. 网站分析结果

### 1.1 Casino 游戏分类结构

通过对 https://www.kessbet.com/pc/casino 的深入分析（2026年1月），发现以下结构：

| 分类                 | 说明            | 游戏数量 | 游戏示例                                         |
| -------------------- | --------------- | -------- | ------------------------------------------------ |
| **Favorite**   | 用户收藏夹      | 动态     | 用户个人收藏的游戏                               |
| **Popular**    | 热门游戏        | ~28款    | Spribe Aviator, Gates of Olympus, Sweet Bonanza  |
| **Aviator**    | 飞行类Crash游戏 | ~5款     | Spribe Aviator（核心爆款）                       |
| **Crash Game** | 崩盘类游戏      | ~12款    | High Flyer, Spaceman, Big Bass Crash, Spribe系列 |
| **Slots**      | 老虎机          | ~28款+   | Gates of Olympus, Sugar Rush, Megaways系列       |
| **Virtual**    | 虚拟游戏        | 若干     | 虚拟体育等                                       |
| **Live Games** | 真人游戏        | 若干     | 真人荷官游戏                                     |
| **Recent**     | 最近玩过        | 动态     | 用户历史记录（需登录）                           |
| **New Games**  | 新游戏          | ~14款    | Running Sushi, Bow of Artemis, Hand of Midas 2   |

### 1.2 游戏提供商分析

| 提供商                   | 主要品类      | 代表游戏                                                                     | 特点                           |
| ------------------------ | ------------- | ---------------------------------------------------------------------------- | ------------------------------ |
| **Spribe**         | Crash/Aviator | Aviator, Keno, Goal, Hi Lo, Plinko, Dice, Mines, Mini Roulette, Trader       | 快节奏、低门槛、即时反馈       |
| **Pragmatic Play** | Slots         | Gates of Olympus, Sweet Bonanza, Sugar Rush, The Dog House系列, Megaways系列 | 高波动性、大奖吸引力、丰富主题 |
| 其他提供商               | 混合          | High Flyer, Spaceman                                                         | 补充品类                       |

## 1.3 游戏特征维度（扩展）

| 特征类型           | 特征名称        | 说明         | 取值示例                                                                |
| ------------------ | --------------- | ------------ | ----------------------------------------------------------------------- |
| **基础属性** | category        | 游戏类型     | Crash, Slots, Live, Virtual                                             |
|                    | provider        | 提供商       | Spribe, Pragmatic Play                                                  |
|                    | volatility      | 波动性       | high/medium/low                                                         |
|                    | rtp             | 返还率       | 92.00 ~ 98.00                                                           |
| **主题标签** | theme           | 游戏主题     | mythology(神话), animal(动物), adventure(冒险), food(美食), asian(亚洲) |
| **玩法特征** | features        | 特殊玩法     | megaways, free_spins, bonus_buy, multiplier, cascading                  |
| **生命周期** | launch_date     | 上线日期     | 用于新游戏标识                                                          |
|                    | lifecycle_stage | 生命周期阶段 | new(7天内), growth, mature, decline                                     |
| **运营属性** | is_featured     | 是否推荐位   | 运营配置                                                                |
|                    | jackpot_enabled | 是否有大奖池 | true/false                                                              |

### 1.4 网站UI/UX特点分析

```
┌─────────────────────────────────────────────────────────────────┐
│  网站交互模式                                                    │
├─────────────────────────────────────────────────────────────────┤
│  1. Tab切换式分类导航 → 支持分类页场景推荐                        │
│  2. 图片卡片式游戏展示 → 缩略图质量影响CTR                        │
│  3. 收藏(Favorite)功能 → 显式正反馈信号                          │
│  4. 最近玩过(Recent)功能 → 召回路之一，支持续玩场景               │
│  5. 新游戏(New Games)专区 → 新游戏冷启动曝光位                   │
│  6. 与体育博彩集成 → 跨域推荐机会(Soccer/Basketball/Tennis等)    │
│  7. Betslip侧边栏 → 上下文感知(当前投注状态)                      │
└─────────────────────────────────────────────────────────────────┘
```

### 1.5 游戏热度分布观察

```
Popular分类游戏分布：
├── Crash/Aviator类 (~40%): Spribe Aviator, High Flyer, Spaceman, Big Bass Crash...
│   └── 特点：快速反馈、短session、高频次
├── Slots类 (~55%): Gates of Olympus, Sweet Bonanza, Megaways系列...
│   └── 特点：长session、中低频次、高波动性Megaways占比高
└── 其他 (~5%): Keno, Mini Roulette等
    └── 特点：休闲向、填充品类
```

---

## 2. 推荐系统设计（一周MVP版本）

### 2.1 设计原则

1. **简单优先**: 先实现能跑通的系统，再迭代优化
2. **数据驱动**: 基于用户行为数据进行推荐
3. **可解释性**: 推荐结果能被理解和解释
4. **实时性**: 支持近实时推荐更新

### 2.2 系统架构（四层漏斗架构）

```
┌─────────────────────────────────────────────────────────────────┐
│                        用户请求层                                │
│    Web/App → API Gateway → Recommendation Service               │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      推荐服务层 (FastAPI)                        │
│  ┌──────────┬──────────┬──────────┬──────────┬───────────────┐ │
│  │ 召回模块  │ 粗排模块  │ 精排模块  │ 重排模块  │  缓存模块    │ │
│  │(Recall)  │(PreRank) │(Ranking) │(ReRank)  │  (Cache)     │ │
│  │ ~500候选 │ ~150候选  │ ~50候选  │ ~20结果  │              │ │
│  └──────────┴──────────┴──────────┴──────────┴───────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        数据存储层                                │
│  ┌──────────┬──────────┬──────────┬──────────────────────────┐ │
│  │  Redis   │  MySQL   │  FAISS   │     Elasticsearch       │ │
│  │(特征缓存)│(业务数据) │(向量索引)│     (游戏检索)           │ │
│  └──────────┴──────────┴──────────┴──────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      实时特征层 (新增)                           │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  Kafka/Flink → 实时行为流 → Redis实时特征 → 特征服务      │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

**四层漏斗设计说明：**

| 层级   | 输入规模   | 输出规模 | 延迟目标 | 模型复杂度      |
| ------ | ---------- | -------- | -------- | --------------- |
| 召回层 | 全量游戏库 | ~500     | <10ms    | 简单/向量检索   |
| 粗排层 | ~500       | ~150     | <15ms    | 中等/双塔向量   |
| 精排层 | ~150       | ~50      | <30ms    | 复杂/DeepFM+DIN |
| 重排层 | ~50        | ~20      | <5ms     | 规则+多样性     |

### 2.3 核心模块设计

#### 模块A：多路召回（Recall）

```
召回策略（六路召回 + 动态配额）：

├── 1. 协同过滤召回 (Collaborative Filtering)
│   ├── Item-CF: 基于物品的协同过滤
│   │   └── 根据用户历史行为，找到相似游戏
│   ├── Swing召回: 改进的物品相似度算法
│   │   └── 对共现关系建模更准确，适合隐式反馈
│   └── 配额: 活跃用户80个，新用户20个
│
├── 2. 双塔模型召回 (Two-Tower Model)
│   ├── User Tower: 用户特征编码
│   │   └── 用户ID + 用户画像 + 行为序列 → User Embedding
│   ├── Item Tower: 游戏特征编码
│   │   └── 游戏ID + 类目 + 提供商 + 特征 → Item Embedding
│   ├── 负采样策略: In-batch Negatives + Hard Negative Mining
│   └── 配额: 活跃用户100个，新用户50个
│
├── 3. 内容召回 (Content-Based) 【新增】
│   ├── 属性召回: 基于用户偏好的category/provider/volatility直接匹配
│   ├── 标签召回: 基于游戏themes和features的语义匹配
│   │   └── 用户喜欢神话主题 → 推荐Gates of Olympus, Power of Thor等
│   └── 配额: 所有用户50个（冷启动友好）
│
├── 4. 热门召回 (Hot Recall) 【增强】
│   ├── 全站实时热门: 过去1小时的点击/投注排行
│   ├── 分类热门: 各类目(Slots/Crash/Live)下的Top游戏
│   ├── 分时段热门: 早/中/晚/深夜不同的热门榜单
│   ├── 分人群热门: 高净值用户热门 vs 普通用户热门
│   ├── 高RTP热门: RTP > 96%的高返还游戏榜单
│   └── 配额: 新用户100个，活跃用户30个
│
├── 5. 新游戏召回 (New Game Recall) 【新增】
│   ├── 7天内新游戏: 强制曝光池
│   ├── 基于内容相似的新游戏推荐
│   └── 配额: 固定20个（保证新游戏曝光）
│
└── 6. 个性化召回 (Personalized Recall) 【新增】
    ├── 回流召回: 用户30天未玩但历史喜欢的游戏
    ├── 续玩召回: 最近玩过但未完成Session的游戏(Recent)
    ├── 收藏召回: 用户Favorite列表中的游戏
    └── 配额: 动态，基于用户状态
```

**召回流程图（改进版）：**

```
                         ┌─────────────────┐
                         │   用户请求      │
                         │   + 场景识别    │
                         └────────┬────────┘
                                  │
                    ┌─────────────┴─────────────┐
                    │      用户类型判断          │
                    │  新用户 / 活跃 / 流失回归  │
                    └─────────────┬─────────────┘
                                  │
     ┌──────────┬──────────┬──────┴──────┬──────────┬──────────┐
     │          │          │             │          │          │
     ▼          ▼          ▼             ▼          ▼          ▼
┌────────┐┌────────┐┌────────────┐┌────────┐┌────────┐┌────────┐
│Item-CF ││双塔模型││  内容召回   ││热门召回││新游戏  ││个性化  │
│+Swing  ││(FAISS) ││ 属性+标签  ││(多维度)││ 召回   ││ 召回   │
└───┬────┘└───┬────┘└─────┬──────┘└───┬────┘└───┬────┘└───┬────┘
    │         │           │           │         │         │
    │ 动态    │  动态     │  50个     │ 动态    │  20个   │ 动态
    │ 配额    │  配额     │           │ 配额    │  固定   │ 配额
    └─────────┴───────────┴───────────┴─────────┴─────────┘
                                  │
                                  ▼
                       ┌─────────────────┐
                       │  合并去重+截断   │
                       │  (~500个候选)   │
                       └────────┬────────┘
                                │
                                ▼
                       ┌─────────────────┐
                       │    粗排模块     │
                       │  (~150个候选)   │
                       └─────────────────┘
```

**动态召回配额策略：**

| 用户类型       | Item-CF | 双塔 | 内容 | 热门 | 新游戏 | 个性化 | 总计 |
| -------------- | ------- | ---- | ---- | ---- | ------ | ------ | ---- |
| 新用户(行为<5) | 20      | 50   | 80   | 100  | 20     | 0      | ~270 |
| 活跃用户       | 80      | 100  | 50   | 30   | 20     | 50     | ~330 |
| 流失回归       | 40      | 60   | 50   | 50   | 20     | 80     | ~300 |

#### 模块B：粗排（Pre-Ranking）【新增】

```
粗排模块设计：
目标：从~500候选快速筛选到~150，平衡效率与效果

┌─────────────────────────────────────────────────────────────┐
│                    粗排双塔模型                               │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  用户塔 (在线计算)          游戏塔 (离线预计算)       │    │
│  │  ┌─────────────┐           ┌─────────────┐          │    │
│  │  │ user_id     │           │ game_id     │          │    │
│  │  │ 用户画像    │           │ category    │          │    │
│  │  │ 实时特征    │    dot    │ provider    │          │    │
│  │  │ ↓           │  product  │ features    │          │    │
│  │  │ User Embed  │ ───────── │ Item Embed  │          │    │
│  │  │ (64维)      │           │ (64维,预存) │          │    │
│  │  └─────────────┘           └─────────────┘          │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
│  优势：游戏Embedding预计算存储，在线只需用户塔推理+向量内积    │
│  延迟：< 15ms (500个候选)                                   │
└─────────────────────────────────────────────────────────────┘
```

#### 模块C：精排（Ranking）

```
精排模型（多模型融合 + 多目标优化）：

┌─────────────────────────────────────────────────────────────┐
│                    DeepFM 模型                               │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  特征输入（扩展版）                                   │    │
│  │  ├── 用户静态特征: user_id, 用户等级, 注册天数        │    │
│  │  │   └── 生命周期阶段, 风险偏好分数                   │    │
│  │  ├── 用户实时特征【新增】:                            │    │
│  │  │   ├── Session内已浏览游戏数                        │    │
│  │  │   ├── Session内点击序列(最近5个)                   │    │
│  │  │   ├── 距离上次投注的时间间隔                       │    │
│  │  │   └── 当前账户余额区间                             │    │
│  │  ├── 游戏特征: game_id, category, provider, rtp      │    │
│  │  │   └── volatility, themes, features, lifecycle     │    │
│  │  ├── 交叉特征【增强】:                                │    │
│  │  │   ├── user_category历史CTR                        │    │
│  │  │   ├── user_provider历史转化率                     │    │
│  │  │   └── user_volatility偏好匹配度                   │    │
│  │  └── 上下文: 时间, 设备, 场景, 渠道                   │    │
│  └─────────────────────────────────────────────────────┘    │
│                          │                                   │
│            ┌─────────────┼─────────────┐                    │
│            ▼             ▼             ▼                    │
│     ┌──────────┐  ┌──────────┐  ┌──────────┐               │
│     │ 一阶特征  │  │ FM二阶   │  │ DNN深度  │               │
│     │ (Linear) │  │交叉特征   │  │ 特征交互 │               │
│     └────┬─────┘  └────┬─────┘  └────┬─────┘               │
│          └─────────────┼─────────────┘                      │
│                        ▼                                     │
│              ┌─────────────────┐                            │
│              │   Sigmoid输出   │ → CTR预估                  │
│              └─────────────────┘                            │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                     DIN/DIEN 模型                            │
│  (Deep Interest Network / Deep Interest Evolution Network)  │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  用户行为序列: [game_1, game_2, ..., game_n]         │    │
│  │  + 行为类型: [click, play, bet, ...]                 │    │
│  │  + 行为时间: [t_1, t_2, ..., t_n]                    │    │
│  │                     │                                │    │
│  │                     ▼                                │    │
│  │  ┌───────────────────────────────────────────────┐  │    │
│  │  │    Attention机制 + 兴趣演化(DIEN可选)          │  │    │
│  │  │    ┌──────────────────────────────────────┐   │  │    │
│  │  │    │  AUGRU: 兴趣演化建模                  │   │  │    │
│  │  │    │  捕捉用户兴趣随时间的变化              │   │  │    │
│  │  │    └──────────────────────────────────────┘   │  │    │
│  │  └───────────────────────────────────────────────┘  │    │
│  └─────────────────────────────────────────────────────┘    │
│                          │                                   │
│                          ▼                                   │
│              ┌─────────────────┐                            │
│              │  MLP + Sigmoid  │ → CTR预估                  │
│              └─────────────────┘                            │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│               多目标学习 MMOE/PLE 【新增】                    │
│  ┌─────────────────────────────────────────────────────┐    │
│  │                    共享Expert层                       │    │
│  │  ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐        │    │
│  │  │Expert1 │ │Expert2 │ │Expert3 │ │Expert4 │        │    │
│  │  └────┬───┘ └────┬───┘ └────┬───┘ └────┬───┘        │    │
│  │       └──────────┼──────────┼──────────┘            │    │
│  │                  ▼          ▼                        │    │
│  │           ┌──────────┐ ┌──────────┐                 │    │
│  │           │Gate_CTR  │ │Gate_CVR  │  (门控网络)      │    │
│  │           └────┬─────┘ └────┬─────┘                 │    │
│  │                ▼            ▼                        │    │
│  │           ┌────────┐  ┌────────┐                    │    │
│  │           │Tower   │  │Tower   │                    │    │
│  │           │ CTR    │  │ CVR    │                    │    │
│  │           └────┬───┘  └────┬───┘                    │    │
│  │                ▼            ▼                        │    │
│  │              pCTR        pCVR                        │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
│  最终分数 = pCTR × pCVR × (1 + α×时长因子 + β×留存因子)      │
└─────────────────────────────────────────────────────────────┘

模型融合策略（改进版）：
├── 动态权重融合（基于用户行为序列长度）
│   ├── seq_len < 10: Final = 0.7×DeepFM + 0.3×DIN
│   └── seq_len >= 10: Final = 0.3×DeepFM + 0.7×DIN
├── 场景化选择
│   ├── 首页推荐: DIN为主（个性化强）
│   ├── 分类页推荐: DeepFM为主（泛化强）
│   └── 相似推荐: Item-CF直出，跳过精排
└── 多目标融合
    └── Score = pCTR^0.3 × pCVR^0.5 × p时长^0.2
```

#### 模块D：重排（Re-Ranking）【新增】

```
重排模块设计：
目标：在精排结果基础上，应用业务规则、多样性控制、位置偏差校正

┌─────────────────────────────────────────────────────────────┐
│                      重排策略                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. 多样性控制（DPP / MMR算法）                              │
│     ├── 类目多样性: 连续位置同类型游戏 ≤ 2个                 │
│     ├── 提供商多样性: 连续位置同提供商游戏 ≤ 3个             │
│     ├── 主题多样性: 前10个结果覆盖至少3个主题                │
│     └── 波动性分布: 高/中/低波动性游戏均衡分布               │
│                                                             │
│  2. 位置偏差校正 (Position Bias Debias)                     │
│     └── 使用IPW或因果推断方法校正位置偏差                    │
│                                                             │
│  3. 业务规则打散                                             │
│     ├── Megaways系列不连续出现                               │
│     ├── Spribe系列间隔展示                                   │
│     └── 同一主题(如Sweet系列)打散                            │
│                                                             │
│  4. 强制插入                                                 │
│     ├── 新游戏强制位置: 位置3、8、15                         │
│     ├── 运营配置游戏: 根据运营需求插入                       │
│     └── 大奖游戏: jackpot_enabled游戏适当曝光                │
│                                                             │
│  5. 过滤规则                                                 │
│     ├── 过滤已浏览游戏(Session内)                            │
│     ├── 过滤7天内玩过的游戏(可配置)                          │
│     └── 过滤用户不感兴趣类目(如果有明确负反馈)               │
│                                                             │
└─────────────────────────────────────────────────────────────┘

重排算法示例（MMR多样性）：
┌─────────────────────────────────────────────────────────────┐
│  MMR(g) = λ × Rel(g) - (1-λ) × max(Sim(g, g'))             │
│                                   g'∈S                      │
│  其中：                                                      │
│  - Rel(g): 精排模型给出的相关性分数                          │
│  - Sim(g, g'): 游戏g与已选集合S中游戏的相似度                │
│  - λ: 平衡因子，通常取0.5~0.7                               │
└─────────────────────────────────────────────────────────────┘
```

#### 模块E：策略调控（增强版）

```
业务策略矩阵：
┌─────────────────────────────────────────────────────────────┐
│  1. 多样性控制（已移至重排模块）                              │
│                                                             │
│  2. 新游戏扶持策略                                           │
│     ├── 7天内新游戏权重 × 1.5                                │
│     ├── 新游戏强制曝光池: 每次推荐至少1款新游戏               │
│     ├── 新游戏专属推荐位: 位置3/8/15                         │
│     └── 新游戏数据收集: 前1000次曝光后评估是否继续扶持       │
│                                                             │
│  3. 实时调控                                                 │
│     ├── 运营可配置的游戏权重(boost/demote)                   │
│     ├── 活动期间特定游戏加权(节日主题等)                     │
│     ├── 大奖开出后的热度加权                                 │
│     └── 游戏下线/维护的实时过滤                              │
│                                                             │
│  4. 流量调控                                                 │
│     ├── A/B测试分流能力                                      │
│     ├── 分层实验(召回层/排序层可独立实验)                    │
│     └── 灰度发布支持                                         │
│                                                             │
│  5. 安全合规策略                                             │
│     ├── 用户投注限额提醒                                     │
│     ├── 问题用户游戏限制                                     │
│     └── 合规游戏过滤(地区限制等)                             │
└─────────────────────────────────────────────────────────────┘
```

#### 模块F：冷启动策略【新增】

```
┌─────────────────────────────────────────────────────────────┐
│                    新用户冷启动                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  阶段1: 首次访问 (行为数=0)                                  │
│  ├── 推荐策略:                                               │
│  │   ├── 60% 高质量热门游戏(Popular分类)                    │
│  │   ├── 20% 新游戏(New Games分类)                          │
│  │   ├── 20% 类目多样性填充                                 │
│  │   └── 优先展示Aviator/Gates of Olympus等爆款             │
│  ├── Side Information利用:                                   │
│  │   ├── 注册渠道 → 渠道用户偏好                            │
│  │   ├── 设备类型 → 设备用户偏好                            │
│  │   └── 注册时段 → 时段热门                                │
│  └── 兴趣探索引导:                                           │
│      └── "选择你喜欢的游戏类型" 引导页(可选)                │
│                                                             │
│  阶段2: 轻度用户 (1-5次行为)                                 │
│  ├── 推荐策略:                                               │
│  │   ├── 40% 基于已有行为的Item-CF                          │
│  │   ├── 30% 热门游戏                                       │
│  │   ├── 20% 内容召回(基于已玩游戏属性)                     │
│  │   └── 10% 探索性推荐                                     │
│  └── 快速学习:                                               │
│      └── 实时更新用户Embedding(双塔增量更新)                │
│                                                             │
│  阶段3: 活跃用户 (>5次行为)                                  │
│  └── 切换到标准个性化推荐流程                                │
│                                                             │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                    新游戏冷启动                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  阶段1: 上线初期 (0-3天, 曝光<500)                           │
│  ├── 强制曝光池: 进入所有用户推荐的前20位候选               │
│  ├── 随机曝光: 20%用户随机看到新游戏                        │
│  └── 数据收集: 收集初始CTR/CVR数据                          │
│                                                             │
│  阶段2: 快速验证期 (3-7天, 曝光500-2000)                     │
│  ├── 基于内容相似: 用相似游戏的表现预估新游戏潜力           │
│  │   └── 例: 新Megaways游戏 → 参考其他Megaways的用户群      │
│  ├── Explore/Exploit平衡:                                    │
│  │   ├── Thompson Sampling: 对CTR的Beta分布采样             │
│  │   └── UCB算法: 给不确定性高的新游戏更多探索机会          │
│  └── 动态调整曝光: 表现好的加大曝光，差的减少               │
│                                                             │
│  阶段3: 稳定期 (>7天)                                        │
│  ├── 积累足够数据后，进入标准推荐流程                       │
│  ├── 新游戏标签保留30天(New Games分类)                      │
│  └── 根据实际表现调整游戏lifecycle_stage                    │
│                                                             │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                    流失用户回归冷启动                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  识别: 30天未活跃的用户回归                                  │
│  ├── 推荐策略:                                               │
│  │   ├── 40% 用户历史最爱游戏(唤醒记忆)                     │
│  │   ├── 30% 流失期间的新游戏/热门游戏(展示变化)            │
│  │   ├── 20% 相似用户当前喜欢的游戏(借鉴同类)               │
│  │   └── 10% 探索性推荐                                     │
│  └── 特殊处理:                                               │
│      └── 用户画像降权(过期数据可靠性下降)                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 3. 数据模型设计

### 3.1 用户画像表 (user_profile) 【增强版】

```sql
CREATE TABLE user_profile (
    user_id VARCHAR(64) PRIMARY KEY,
  
    -- 基础信息
    register_time DATETIME,
    register_channel VARCHAR(32),      -- 注册渠道【新增】
    last_active_time DATETIME,
    user_level INT,
  
    -- 用户生命周期【新增】
    lifecycle_stage VARCHAR(20),       -- new/growth/mature/decline/churn
    active_days_30d INT,               -- 近30天活跃天数
    is_churn_risk TINYINT,             -- 是否流失风险用户
  
    -- 游戏偏好 (JSON)
    preferred_categories JSON,  -- {"Slots": 0.6, "Crash": 0.3, "Live": 0.1}
    preferred_providers JSON,   -- {"Pragmatic": 0.7, "Spribe": 0.3}
    preferred_volatility VARCHAR(20),  -- high/medium/low
    preferred_themes JSON,      -- {"mythology": 0.5, "animal": 0.3}【新增】
  
    -- 风险偏好【新增】
    risk_preference_score DECIMAL(5,4),  -- 0~1, 基于波动性选择计算
    bet_pattern VARCHAR(20),             -- small_frequent/large_rare/mixed
    avg_bet_amount DECIMAL(15,2),        -- 平均单次投注
  
    -- 行为统计
    total_play_count INT,
    total_play_duration BIGINT,  -- seconds
    total_bet_amount DECIMAL(15,2),
    total_win_amount DECIMAL(15,2),     -- 总赢取金额【新增】
    avg_session_duration INT,
    favorite_game_count INT,            -- 收藏游戏数【新增】
  
    -- 类目级统计【新增】
    category_play_stats JSON,  -- {"Slots": {"play_count": 100, "ctr": 0.15}, ...}
    provider_play_stats JSON,  -- {"Pragmatic": {"play_count": 80, "cvr": 0.3}, ...}
  
    -- 更新时间
    updated_at DATETIME,
  
    INDEX idx_lifecycle (lifecycle_stage),
    INDEX idx_last_active (last_active_time)
);
```

### 3.2 游戏信息表 (game_info) 【增强版】

```sql
CREATE TABLE game_info (
    game_id VARCHAR(64) PRIMARY KEY,
    game_name VARCHAR(128),
  
    -- 分类信息
    category VARCHAR(32),       -- Slots/Crash/Live/Virtual
    sub_category VARCHAR(32),   -- Megaways/Classic/Aviator【新增】
    provider VARCHAR(64),       -- Spribe/Pragmatic Play
  
    -- 游戏属性
    rtp DECIMAL(5,2),          -- 返还率 96.50
    volatility VARCHAR(20),     -- high/medium/low
    volatility_score DECIMAL(3,2),  -- 数值化波动性 1~5【新增】
    themes JSON,                -- ["mythology", "adventure"]
    features JSON,              -- ["megaways", "free_spins", "bonus"]
    min_bet DECIMAL(10,2),      -- 最小投注【新增】
    max_bet DECIMAL(10,2),      -- 最大投注【新增】
  
    -- 状态信息
    status TINYINT,            -- 1:上线 0:下线
    launch_date DATE,
    lifecycle_stage VARCHAR(20), -- new/growth/mature/decline【新增】
    thumbnail_url VARCHAR(256),
  
    -- 运营属性【新增】
    is_featured TINYINT,        -- 是否推荐位
    is_jackpot TINYINT,         -- 是否有大奖池
    boost_weight DECIMAL(3,2),  -- 运营加权 0.5~2.0
  
    -- 统计信息 (定期更新)
    play_count_1h INT,          -- 实时热度【新增】
    play_count_24h INT,         -- 日热度【新增】
    play_count_7d INT,
    play_count_30d INT,
    unique_players_7d INT,      -- 独立玩家数【新增】
    avg_rating DECIMAL(3,2),
    ctr_7d DECIMAL(5,4),        -- 7天CTR【新增】
    cvr_7d DECIMAL(5,4),        -- 7天转化率【新增】
    avg_session_duration INT,   -- 平均游戏时长【新增】
  
    -- Embedding向量(粗排用)【新增】
    item_embedding BLOB,        -- 64维float32向量
  
    updated_at DATETIME,
  
    INDEX idx_category (category),
    INDEX idx_provider (provider),
    INDEX idx_lifecycle (lifecycle_stage),
    INDEX idx_launch_date (launch_date)
);
```

### 3.3 实时特征表 (Redis结构) 【新增】

```
实时特征存储结构：

1. 用户Session特征 (TTL: 30分钟)
   Key: user:session:{user_id}
   Type: Hash
   Fields:
     - session_start_time: 当前Session开始时间
     - viewed_games: JSON数组，已浏览游戏列表
     - clicked_games: JSON数组，已点击游戏列表
     - played_games: JSON数组，已玩游戏列表
     - last_action_time: 最后一次行为时间
     - current_balance_tier: 当前余额区间(low/medium/high)

2. 用户行为序列 (TTL: 7天)
   Key: user:behavior_seq:{user_id}
   Type: List (最近100条)
   Value: JSON {game_id, behavior_type, timestamp, duration}

3. 游戏实时热度 (TTL: 1小时)
   Key: game:hot:hourly
   Type: Sorted Set
   Score: 点击/游戏次数
   Member: game_id

4. 用户实时Embedding (TTL: 1天)
   Key: user:embedding:{user_id}
   Type: String (64维float32向量的bytes)
```

### 3.3 用户行为表 (user_behavior)

```sql
CREATE TABLE user_behavior (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id VARCHAR(64),
    game_id VARCHAR(64),
  
    -- 行为类型
    behavior_type VARCHAR(20),  -- view/click/play/bet/favorite
  
    -- 行为详情
    duration INT,               -- 游戏时长(秒)
    bet_amount DECIMAL(15,2),   -- 投注金额
    win_amount DECIMAL(15,2),   -- 赢取金额
  
    -- 时间
    created_at DATETIME,
  
    INDEX idx_user_time (user_id, created_at),
    INDEX idx_game_time (game_id, created_at)
);
```

### 3.4 推荐结果表 (recommendation_cache)

```sql
CREATE TABLE recommendation_cache (
    user_id VARCHAR(64),
    scene VARCHAR(32),          -- home/category/similar
  
    -- 推荐结果
    game_ids JSON,              -- ["game1", "game2", ...]
    scores JSON,                -- [0.95, 0.88, ...]
  
    -- 缓存控制
    created_at DATETIME,
    expired_at DATETIME,
  
    PRIMARY KEY (user_id, scene)
);
```

---

## 4. API 接口设计

### 4.1 获取推荐列表

```
GET /api/v1/recommend/games

请求参数:
- user_id: string (必填)
- scene: string (必填) - home/slots/crash/live/similar
- game_id: string (可选) - 相似推荐时使用
- page: int (默认1)
- page_size: int (默认20)

响应:
{
    "code": 0,
    "data": {
        "games": [
            {
                "game_id": "game_001",
                "game_name": "Gates of Olympus",
                "category": "Slots",
                "provider": "Pragmatic Play",
                "thumbnail_url": "https://...",
                "score": 0.95,
                "reason": "基于您对老虎机的喜好推荐"
            }
        ],
        "total": 100,
        "has_more": true
    }
}
```

### 4.2 记录用户行为

```
POST /api/v1/behavior/track

请求体:
{
    "user_id": "user_001",
    "game_id": "game_001",
    "behavior_type": "play",  // view/click/play/bet/favorite
    "duration": 300,
    "bet_amount": 100.00,
    "win_amount": 150.00
}

响应:
{
    "code": 0,
    "message": "success"
}
```

### 4.3 获取相似游戏

```
GET /api/v1/recommend/similar

请求参数:
- game_id: string (必填)
- limit: int (默认10)

响应:
{
    "code": 0,
    "data": {
        "games": [...]
    }
}
```

---

## 5. 开发计划（增强版）

### 5.1 两周 MVP 版本

| 天数   | 任务             | 详细内容                                           |
| ------ | ---------------- | -------------------------------------------------- |
| Day 1  | 基础架构         | 项目结构、数据库表(增强版)、FastAPI框架、Redis配置 |
| Day 2  | 数据准备         | 样本构建、特征工程(含实时特征设计)、训练数据生成   |
| Day 3  | 召回模块         | Item-CF实现、热门召回(多维度)、内容召回、多路合并  |
| Day 4  | 粗排模块【新增】 | 粗排双塔模型、Item Embedding预计算、粗排服务       |
| Day 5  | 精排模块         | DeepFM模型训练、DIN模型训练、在线推理服务          |
| Day 6  | 重排模块【新增】 | MMR多样性算法、业务规则引擎、强制插入逻辑          |
| Day 7  | 冷启动【新增】   | 新用户冷启动策略、新游戏冷启动策略                 |
| Day 8  | 接口联调         | API测试、完整链路测试、性能优化                    |
| Day 9  | 实时特征【新增】 | Session特征采集、实时特征服务、Kafka接入           |
| Day 10 | 部署上线         | Docker部署、监控埋点、文档完善、灰度发布           |

### 5.2 详细开发任务

#### Day 1-2: 基础架构与数据准备

```
□ 项目结构初始化
□ 数据库表创建 (user_profile增强版, game_info增强版, user_behavior)
□ FastAPI 基础框架搭建
□ Redis 连接配置 (特征缓存、行为序列、Session特征)
□ 样本数据收集与清洗
□ 正负样本构建 (曝光-点击-转化多目标)
□ 特征工程 (用户特征、物品特征、交叉特征、实时特征设计)
□ Kafka Topic创建 (行为日志)
```

#### Day 3: 召回模块实现

```
□ Item-CF 相似度矩阵计算 (含IUF权重)
□ Item-CF 在线召回服务
□ 热门召回 (多维度: 全站/分类/分时段/分人群)
□ 内容召回 (属性匹配 + 标签召回)
□ 新游戏召回 (强制曝光池)
□ 多路召回合并去重 (动态配额)
□ 召回层API接口
```

#### Day 4: 粗排模块实现【新增】

```
□ 粗排双塔模型设计与实现
□ Item Embedding离线预计算脚本
□ Item Embedding Redis存储
□ 粗排在线服务 (向量内积计算)
□ 粗排与召回层集成
□ 粗排效果评估
```

#### Day 5: 精排模块实现

```
□ DeepFM 模型实现 (PyTorch)
□ DIN 模型实现 (Attention机制)
□ 特征编码器 (类别特征 Embedding)
□ 模型训练脚本
□ 模型评估 (AUC, GAUC, LogLoss)
□ Triton Inference Server 部署配置
□ 在线推理接口 (动态批处理)
□ 模型融合逻辑 (动态权重)
```

#### Day 6: 重排模块实现【新增】

```
□ MMR多样性算法实现
□ 类目/提供商/主题打散规则
□ 新游戏强制插入逻辑
□ 运营配置boost/demote
□ Session内已浏览过滤
□ 重排服务与精排层集成
□ 重排效果评估 (多样性指标)
```

#### Day 7: 冷启动策略实现【新增】

```
□ 新用户冷启动策略 (三阶段)
□ Side Information利用 (渠道/设备/时段)
□ 新游戏冷启动策略 (强制曝光 + Explore/Exploit)
□ Thompson Sampling / UCB算法实现
□ 流失用户回归策略
□ 冷启动效果监控埋点
```

#### Day 8: 接口联调与优化

```
□ 完整推荐链路测试 (召回→粗排→精排→重排)
□ 性能压测与优化 (目标: P99 < 100ms)
□ 特征缓存优化 (Redis预热 + 本地LRU)
□ 模型推理批处理优化
□ 异常处理与降级策略 (超时降级到热门)
□ A/B测试框架基础实现
```

#### Day 9: 实时特征服务【新增】

```
□ Kafka行为日志消费
□ Flink实时特征计算 (或简化版Python消费)
□ Session特征实时更新 (Redis)
□ 实时热门榜单更新
□ 用户Embedding实时/增量更新
□ 特征一致性验证
```

#### Day 10: 部署与文档

```
□ Docker 容器化 (所有服务)
□ Docker Compose 编排
□ 监控指标埋点 (Prometheus + Grafana)
□ 告警规则配置
□ 接口文档完善 (OpenAPI)
□ 灰度发布策略
□ 部署上线
```

### 5.3 后续迭代计划 (Week 3-6)

#### Week 3: 双塔模型与召回增强

```
□ 双塔模型训练 (In-batch Negatives + Hard Negative Mining)
□ FAISS 索引构建与优化
□ 双塔召回接入 (替换粗排双塔或独立召回路)
□ Swing召回实现
□ 召回效果评估与调优
□ 召回多样性优化
```

#### Week 4: 精排模型升级

```
□ DIEN兴趣演化模型实现
□ MMOE/PLE多目标学习 (pCTR + pCVR)
□ 特征扩展 (更多交叉特征、统计特征)
□ 模型调优 (超参搜索、Embedding维度)
□ 模型蒸馏 (在线推理加速)
□ 在线学习 (增量更新)
```

#### Week 5: 全链路优化

```
□ A/B 测试正式上线
□ 分层实验能力 (召回层/排序层独立实验)
□ 多目标融合优化 (pCTR×pCVR×时长因子)
□ 实时特征服务稳定性优化
□ 系统性能优化 (GPU加速、缓存优化)
□ 位置偏差校正 (IPW/因果推断)
```

#### Week 6: 高级特性

```
□ 序列推荐模型 (SASRec/GRU4Rec)
□ 知识图谱增强 (游戏-主题-提供商图谱)
□ 跨域推荐探索 (Sports ↔ Casino)
□ 强化学习探索 (Bandit策略)
□ 长短期兴趣分离建模
```

---

## 6. 技术选型（增强版）

| 组件               | 选型                       | 理由                                          |
| ------------------ | -------------------------- | --------------------------------------------- |
| **服务层**   |                            |                                               |
| Web框架            | FastAPI                    | 高性能、自动文档、类型检查、异步支持          |
| API网关            | Kong/Nginx                 | 限流、鉴权、负载均衡                          |
| **存储层**   |                            |                                               |
| 业务数据库         | MySQL 8.0                  | 成熟稳定、JSON支持                            |
| 缓存               | Redis Cluster              | 高性能、支持多种数据结构、行为序列存储        |
| 向量检索           | FAISS / Milvus             | FAISS单机快速、Milvus分布式扩展               |
| 特征存储           | Redis + HBase              | 实时特征(Redis) + 离线特征(HBase)             |
| **实时计算** |                            |                                               |
| 消息队列           | Kafka                      | 高吞吐、持久化、行为日志收集                  |
| 流处理             | Flink                      | 实时特征计算、实时热度统计                    |
| **模型层**   |                            |                                               |
| 深度学习           | PyTorch 2.0                | 动态图、调试友好、社区活跃、torch.compile加速 |
| 模型训练           | PyTorch Lightning          | 简化训练流程、分布式训练支持                  |
| 模型服务           | Triton Inference Server    | 多模型管理、动态批处理、GPU加速               |
| 特征工程           | Feast                      | 特征存储与服务、特征一致性保证                |
| **离线计算** |                            |                                               |
| 批处理             | Spark                      | 大规模数据处理、相似度矩阵计算                |
| 任务调度           | Airflow                    | DAG任务编排、依赖管理                         |
| 任务队列           | Celery                     | 异步任务、定时任务                            |
| **监控运维** |                            |                                               |
| 监控               | Prometheus + Grafana       | 指标采集与可视化                              |
| 日志               | ELK Stack                  | 日志收集与分析                                |
| 链路追踪           | Jaeger                     | 分布式链路追踪                                |
| **部署**     |                            |                                               |
| 容器化             | Docker + K8s               | 容器化部署、弹性伸缩                          |
| CI/CD              | GitLab CI / GitHub Actions | 自动化构建与部署                              |

### 6.1 召回层技术栈（增强版）

```
┌─────────────────────────────────────────────────────────────┐
│                      召回层架构                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  协同过滤召回 (Item-CF + Swing)                              │
│  ├── 离线: Spark计算相似度矩阵 (每日更新)                    │
│  ├── 存储: Redis Hash (item:sim:game_id → {game_id: score}) │
│  ├── 在线: 根据用户历史查询相似游戏                          │
│  └── Swing算法: 改进共现关系建模，更适合隐式反馈             │
│                                                             │
│  双塔模型召回                                                │
│  ├── 训练: PyTorch + In-batch Negatives + Hard Negative     │
│  ├── 索引: FAISS (IVF + PQ, 支持百万级游戏)                 │
│  ├── User Embedding: 在线实时计算 (Triton Inference)        │
│  ├── Item Embedding: 离线计算，每小时增量更新索引            │
│  └── 负采样: 热门游戏降采样，避免trivial pattern            │
│                                                             │
│  内容召回【新增】                                            │
│  ├── 属性匹配: ES查询用户偏好的category/provider/volatility │
│  ├── 标签召回: ES语义匹配themes和features                   │
│  └── 规则引擎: Drools/自研规则引擎                          │
│                                                             │
│  热门召回（多维度）                                          │
│  ├── 实时热门: Flink实时统计 → Redis ZSET                   │
│  ├── 分时段热门: Celery Beat定时聚合                        │
│  ├── 分人群热门: 按用户画像分群的热门榜                      │
│  └── 高RTP热门: RTP > 96%的游戏热门榜                       │
│                                                             │
│  个性化召回【新增】                                          │
│  ├── 续玩召回: Redis用户Session记录                         │
│  ├── 收藏召回: MySQL Favorite表                             │
│  └── 回流召回: 用户历史高分游戏                              │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 6.2 粗排层技术栈【新增】

```
┌─────────────────────────────────────────────────────────────┐
│                      粗排层架构                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  粗排双塔模型                                                │
│  ├── 设计原则: 轻量级，延迟 < 15ms                          │
│  ├── User Tower: 在线计算，输入简化特征                      │
│  ├── Item Tower: 离线预计算，存入Redis/MySQL                 │
│  └── 计算方式: 向量内积，GPU可选加速                         │
│                                                             │
│  特征简化                                                    │
│  ├── 用户特征: user_embedding + 实时统计特征(5维)           │
│  ├── 物品特征: item_embedding(预计算)                       │
│  └── 无交叉特征: 保证计算速度                                │
│                                                             │
│  存储方案                                                    │
│  ├── Item Embedding: Redis String (game_id → 64维向量)      │
│  └── 批量查询: Redis MGET批量获取候选物品Embedding           │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 6.3 精排层技术栈（增强版）

```
┌─────────────────────────────────────────────────────────────┐
│                      精排层架构                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  特征工程（增强版）                                          │
│  ├── 用户静态特征: HBase (画像，T+1更新)                    │
│  ├── 用户实时特征【新增】: Redis (Session特征，秒级更新)     │
│  │   ├── Session内浏览/点击序列                             │
│  │   ├── 距离上次投注时间间隔                               │
│  │   └── 当前余额区间                                       │
│  ├── 物品特征: MySQL + Redis Cache                          │
│  ├── 交叉特征: 在线实时计算                                  │
│  │   ├── user_category历史CTR                               │
│  │   ├── user_provider历史转化率                            │
│  │   └── user_volatility偏好匹配度                          │
│  └── 序列特征: Redis List (用户行为序列，最近100条)         │
│                                                             │
│  模型推理                                                    │
│  ├── DeepFM: Triton部署, 动态Batch推理                      │
│  ├── DIN/DIEN: Triton部署, 支持变长序列                     │
│  ├── MMOE多目标【新增】: pCTR + pCVR联合预估                │
│  └── 模型融合: 动态权重 + 场景选择                          │
│                                                             │
│  在线服务优化                                                │
│  ├── P99延迟目标: < 50ms                                    │
│  ├── 特征缓存: Redis预热 + 本地LRU                          │
│  ├── 模型缓存: Triton模型版本管理                           │
│  ├── 批处理: 候选游戏批量推理                                │
│  └── 降级策略: 模型超时降级到热门召回                        │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 6.4 重排层技术栈【新增】

```
┌─────────────────────────────────────────────────────────────┐
│                      重排层架构                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  多样性算法                                                  │
│  ├── MMR (Maximal Marginal Relevance): 基于相似度打散       │
│  ├── DPP (Determinantal Point Process): 概率多样性采样      │
│  └── 规则打散: 类目/提供商/主题间隔规则                      │
│                                                             │
│  业务规则引擎                                                │
│  ├── 强制插入: 新游戏位置、运营配置位置                      │
│  ├── 过滤规则: Session内已浏览、用户负反馈                  │
│  └── 位置偏差校正: IPW方法                                  │
│                                                             │
│  配置中心                                                    │
│  ├── 多样性参数: λ值、连续限制数等                          │
│  ├── 运营配置: 游戏boost/demote、强制曝光                   │
│  └── A/B实验: 不同重排策略对比                              │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 7. 关键算法

### 7.1 协同过滤召回 (Item-CF)

```python
class ItemCFRecall:
    """
    基于物品的协同过滤召回
    """
  
    def __init__(self):
        self.item_similarity = {}  # 游戏相似度矩阵
        self.user_items = {}       # 用户-游戏交互记录
  
    def compute_item_similarity(self, interactions: List[Tuple[str, str, float]]):
        """
        计算游戏相似度矩阵
        使用余弦相似度 + IUF (Inverse User Frequency) 惩罚热门物品
      
        sim(i,j) = Σ_u (1/log(1+|N(u)|)) / sqrt(|N(i)| * |N(j)|)
        """
        # 构建用户-物品倒排索引
        user_items = defaultdict(set)
        item_users = defaultdict(set)
      
        for user_id, game_id, score in interactions:
            user_items[user_id].add(game_id)
            item_users[game_id].add(user_id)
      
        # 计算相似度
        item_sim = defaultdict(dict)
      
        for user_id, games in user_items.items():
            # IUF 权重: 活跃用户贡献降低
            iuf_weight = 1.0 / math.log(1 + len(games))
          
            for game_i in games:
                for game_j in games:
                    if game_i != game_j:
                        item_sim[game_i][game_j] = item_sim[game_i].get(game_j, 0) + iuf_weight
      
        # 归一化
        for game_i, related_games in item_sim.items():
            for game_j in related_games:
                item_sim[game_i][game_j] /= math.sqrt(
                    len(item_users[game_i]) * len(item_users[game_j])
                )
      
        self.item_similarity = item_sim
        self.user_items = user_items
  
    def recall(self, user_id: str, top_k: int = 50) -> List[Tuple[str, float]]:
        """
        为用户召回游戏
      
        score(u,j) = Σ_i∈N(u) sim(i,j) * r_ui
        """
        user_games = self.user_items.get(user_id, set())
        if not user_games:
            return []
      
        candidate_scores = defaultdict(float)
      
        for played_game in user_games:
            similar_games = self.item_similarity.get(played_game, {})
            for game_id, similarity in similar_games.items():
                if game_id not in user_games:  # 过滤已玩游戏
                    candidate_scores[game_id] += similarity
      
        # 排序返回 Top-K
        ranked = sorted(candidate_scores.items(), key=lambda x: x[1], reverse=True)
        return ranked[:top_k]
```

### 7.2 双塔模型召回 (Two-Tower Model)

```python
import torch
import torch.nn as nn
import faiss

class UserTower(nn.Module):
    """
    用户塔：将用户特征编码为向量
    """
    def __init__(self, user_num, embed_dim=64, hidden_dims=[128, 64]):
        super().__init__()
      
        # 用户 ID Embedding
        self.user_embedding = nn.Embedding(user_num, embed_dim)
      
        # 用户特征 MLP
        layers = []
        input_dim = embed_dim + 10  # embed_dim + 其他特征维度
        for hidden_dim in hidden_dims:
            layers.extend([
                nn.Linear(input_dim, hidden_dim),
                nn.ReLU(),
                nn.BatchNorm1d(hidden_dim),
                nn.Dropout(0.2)
            ])
            input_dim = hidden_dim
      
        self.mlp = nn.Sequential(*layers)
        self.output_layer = nn.Linear(hidden_dims[-1], embed_dim)
  
    def forward(self, user_id, user_features):
        """
        输入:
            user_id: [batch_size]
            user_features: [batch_size, feature_dim] 
                - user_level, register_days, total_play_count, 
                - preferred_category_embed, preferred_provider_embed
        输出:
            user_embedding: [batch_size, embed_dim]
        """
        user_embed = self.user_embedding(user_id)
        x = torch.cat([user_embed, user_features], dim=1)
        x = self.mlp(x)
        return self.output_layer(x)


class ItemTower(nn.Module):
    """
    游戏塔：将游戏特征编码为向量
    """
    def __init__(self, game_num, category_num, provider_num, embed_dim=64, hidden_dims=[128, 64]):
        super().__init__()
      
        # 各类 Embedding
        self.game_embedding = nn.Embedding(game_num, embed_dim)
        self.category_embedding = nn.Embedding(category_num, 16)
        self.provider_embedding = nn.Embedding(provider_num, 16)
      
        # 游戏特征 MLP
        layers = []
        input_dim = embed_dim + 16 + 16 + 5  # 游戏embed + category + provider + 其他特征
        for hidden_dim in hidden_dims:
            layers.extend([
                nn.Linear(input_dim, hidden_dim),
                nn.ReLU(),
                nn.BatchNorm1d(hidden_dim),
                nn.Dropout(0.2)
            ])
            input_dim = hidden_dim
      
        self.mlp = nn.Sequential(*layers)
        self.output_layer = nn.Linear(hidden_dims[-1], embed_dim)
  
    def forward(self, game_id, category_id, provider_id, game_features):
        """
        输入:
            game_id: [batch_size]
            category_id: [batch_size]
            provider_id: [batch_size]
            game_features: [batch_size, feature_dim]
                - rtp, volatility_score, play_count_norm, days_since_launch
        输出:
            game_embedding: [batch_size, embed_dim]
        """
        game_embed = self.game_embedding(game_id)
        category_embed = self.category_embedding(category_id)
        provider_embed = self.provider_embedding(provider_id)
      
        x = torch.cat([game_embed, category_embed, provider_embed, game_features], dim=1)
        x = self.mlp(x)
        return self.output_layer(x)


class TwoTowerModel(nn.Module):
    """
    双塔模型
    """
    def __init__(self, user_tower, item_tower, temperature=0.1):
        super().__init__()
        self.user_tower = user_tower
        self.item_tower = item_tower
        self.temperature = temperature
  
    def forward(self, user_inputs, item_inputs):
        user_embed = self.user_tower(**user_inputs)
        item_embed = self.item_tower(**item_inputs)
      
        # L2 归一化
        user_embed = F.normalize(user_embed, p=2, dim=1)
        item_embed = F.normalize(item_embed, p=2, dim=1)
      
        # 内积计算相似度
        logits = torch.matmul(user_embed, item_embed.T) / self.temperature
        return logits
  
    def build_faiss_index(self, all_games):
        """
        构建 FAISS 索引用于在线召回
        """
        game_embeddings = []
        for game in all_games:
            embed = self.item_tower(**game).detach().numpy()
            game_embeddings.append(embed)
      
        embeddings = np.vstack(game_embeddings)
      
        # 使用 IVF + PQ 索引 (适合百万级数据)
        embed_dim = embeddings.shape[1]
        quantizer = faiss.IndexFlatIP(embed_dim)  # Inner Product
        index = faiss.IndexIVFPQ(quantizer, embed_dim, 100, 8, 8)
        index.train(embeddings)
        index.add(embeddings)
      
        return index
  
    def recall(self, user_inputs, faiss_index, top_k=100):
        """
        在线召回
        """
        user_embed = self.user_tower(**user_inputs).detach().numpy()
        user_embed = user_embed / np.linalg.norm(user_embed)
      
        scores, indices = faiss_index.search(user_embed, top_k)
        return list(zip(indices[0], scores[0]))
```

### 7.3 DeepFM 精排模型

```python
class DeepFM(nn.Module):
    """
    DeepFM: FM + DNN 的端到端模型
  
    输出 = sigmoid(y_FM + y_DNN)
  
    y_FM = w_0 + Σ w_i * x_i + Σ Σ <v_i, v_j> * x_i * x_j
    y_DNN = MLP(concat(embeddings))
    """
  
    def __init__(self, feature_dims, embed_dim=16, hidden_dims=[256, 128, 64]):
        super().__init__()
      
        self.feature_dims = feature_dims  # 各特征的维度
        self.num_fields = len(feature_dims)
        self.total_dim = sum(feature_dims)
      
        # FM 一阶部分
        self.first_order_weights = nn.Embedding(self.total_dim, 1)
        self.bias = nn.Parameter(torch.zeros(1))
      
        # FM 二阶部分 + DNN 共享 Embedding
        self.embeddings = nn.ModuleList([
            nn.Embedding(dim, embed_dim) for dim in feature_dims
        ])
      
        # DNN 部分
        dnn_input_dim = self.num_fields * embed_dim
        layers = []
        for hidden_dim in hidden_dims:
            layers.extend([
                nn.Linear(dnn_input_dim, hidden_dim),
                nn.ReLU(),
                nn.BatchNorm1d(hidden_dim),
                nn.Dropout(0.2)
            ])
            dnn_input_dim = hidden_dim
      
        self.dnn = nn.Sequential(*layers)
        self.dnn_output = nn.Linear(hidden_dims[-1], 1)
  
    def forward(self, x):
        """
        输入 x: [batch_size, num_fields] - 各字段的特征索引
        输出: [batch_size, 1] - CTR 预估
        """
        # === FM 一阶 ===
        first_order_input = self._compute_offsets(x)
        first_order = self.first_order_weights(first_order_input).sum(dim=1)
      
        # === FM 二阶 + Embedding ===
        embed_list = []
        for i, embedding in enumerate(self.embeddings):
            embed_list.append(embedding(x[:, i]))
      
        embed_stack = torch.stack(embed_list, dim=1)  # [batch, num_fields, embed_dim]
      
        # 二阶交叉: 0.5 * (Σv_i)^2 - Σv_i^2
        sum_square = embed_stack.sum(dim=1).pow(2)
        square_sum = embed_stack.pow(2).sum(dim=1)
        second_order = 0.5 * (sum_square - square_sum).sum(dim=1, keepdim=True)
      
        # === DNN 部分 ===
        dnn_input = embed_stack.view(x.size(0), -1)
        dnn_output = self.dnn_output(self.dnn(dnn_input))
      
        # === 融合输出 ===
        output = self.bias + first_order + second_order + dnn_output
        return torch.sigmoid(output)
  
    def _compute_offsets(self, x):
        """计算全局特征索引"""
        offsets = torch.tensor([0] + list(np.cumsum(self.feature_dims[:-1]))).to(x.device)
        return x + offsets


# 特征字段定义
DEEPFM_FEATURES = {
    'user_id': 100000,        # 用户ID
    'game_id': 1000,          # 游戏ID
    'category': 10,           # 游戏类目
    'provider': 50,           # 提供商
    'user_level': 20,         # 用户等级
    'volatility': 3,          # 波动性
    'hour_of_day': 24,        # 小时
    'day_of_week': 7,         # 星期几
    'device_type': 5,         # 设备类型
}
```

### 7.4 DIN 精排模型 (Deep Interest Network)

```python
class AttentionLayer(nn.Module):
    """
    DIN 注意力层
    计算候选物品与用户历史行为序列的注意力权重
    """
  
    def __init__(self, embed_dim, hidden_dims=[64, 32]):
        super().__init__()
      
        # 注意力网络: 输入是 [行为embedding, 候选embedding, 行为-候选交互]
        input_dim = embed_dim * 4  # concat(behavior, candidate, behavior-candidate, behavior*candidate)
      
        layers = []
        for hidden_dim in hidden_dims:
            layers.extend([
                nn.Linear(input_dim, hidden_dim),
                nn.PReLU()  # DIN 使用 PReLU
            ])
            input_dim = hidden_dim
      
        layers.append(nn.Linear(hidden_dims[-1], 1))
        self.attention_net = nn.Sequential(*layers)
  
    def forward(self, behavior_embeds, candidate_embed, mask=None):
        """
        输入:
            behavior_embeds: [batch, seq_len, embed_dim] - 用户行为序列
            candidate_embed: [batch, embed_dim] - 候选游戏
            mask: [batch, seq_len] - 行为序列的有效位置
        输出:
            weighted_behavior: [batch, embed_dim] - 加权后的用户兴趣向量
        """
        seq_len = behavior_embeds.size(1)
      
        # 扩展候选 embedding
        candidate_expand = candidate_embed.unsqueeze(1).expand_as(behavior_embeds)
      
        # 构建注意力输入
        attention_input = torch.cat([
            behavior_embeds,
            candidate_expand,
            behavior_embeds - candidate_expand,
            behavior_embeds * candidate_expand
        ], dim=-1)
      
        # 计算注意力分数
        attention_scores = self.attention_net(attention_input).squeeze(-1)  # [batch, seq_len]
      
        # Mask 处理
        if mask is not None:
            attention_scores = attention_scores.masked_fill(mask == 0, -1e9)
      
        # Softmax 归一化
        attention_weights = F.softmax(attention_scores, dim=-1)  # [batch, seq_len]
      
        # 加权求和
        weighted_behavior = torch.bmm(
            attention_weights.unsqueeze(1),  # [batch, 1, seq_len]
            behavior_embeds                   # [batch, seq_len, embed_dim]
        ).squeeze(1)                          # [batch, embed_dim]
      
        return weighted_behavior, attention_weights


class DIN(nn.Module):
    """
    Deep Interest Network
    核心思想：用户兴趣是多样的，针对不同候选物品激活不同的兴趣
    """
  
    def __init__(self, game_num, category_num, provider_num, 
                 embed_dim=32, hidden_dims=[256, 128, 64], max_seq_len=50):
        super().__init__()
      
        self.max_seq_len = max_seq_len
        self.embed_dim = embed_dim
      
        # Embedding 层
        self.game_embedding = nn.Embedding(game_num, embed_dim, padding_idx=0)
        self.category_embedding = nn.Embedding(category_num, embed_dim // 2)
        self.provider_embedding = nn.Embedding(provider_num, embed_dim // 2)
      
        # 注意力层
        self.attention = AttentionLayer(embed_dim * 2)  # game + category + provider
      
        # MLP 层
        # 输入: 用户兴趣向量 + 候选物品特征 + 用户特征 + 上下文特征
        mlp_input_dim = embed_dim * 2 * 2 + 16  # interest + candidate + user_features
      
        layers = []
        for hidden_dim in hidden_dims:
            layers.extend([
                nn.Linear(mlp_input_dim, hidden_dim),
                nn.PReLU(),
                nn.Dropout(0.2)
            ])
            mlp_input_dim = hidden_dim
      
        self.mlp = nn.Sequential(*layers)
        self.output_layer = nn.Linear(hidden_dims[-1], 1)
  
    def forward(self, user_behavior_games, user_behavior_categories, 
                candidate_game, candidate_category, candidate_provider,
                user_features, behavior_mask=None):
        """
        输入:
            user_behavior_games: [batch, seq_len] - 用户行为游戏序列
            user_behavior_categories: [batch, seq_len] - 对应的类目序列
            candidate_game: [batch] - 候选游戏ID
            candidate_category: [batch] - 候选游戏类目
            candidate_provider: [batch] - 候选游戏提供商
            user_features: [batch, feature_dim] - 用户特征
            behavior_mask: [batch, seq_len] - 行为序列mask
        """
        # === 行为序列 Embedding ===
        behavior_game_embed = self.game_embedding(user_behavior_games)
        behavior_cat_embed = self.category_embedding(user_behavior_categories)
        behavior_embed = torch.cat([behavior_game_embed, behavior_cat_embed], dim=-1)
      
        # === 候选物品 Embedding ===
        candidate_game_embed = self.game_embedding(candidate_game)
        candidate_cat_embed = self.category_embedding(candidate_category)
        candidate_prov_embed = self.provider_embedding(candidate_provider)
        candidate_embed = torch.cat([
            candidate_game_embed, 
            candidate_cat_embed
        ], dim=-1)
      
        # === 注意力计算用户兴趣 ===
        user_interest, attention_weights = self.attention(
            behavior_embed, candidate_embed, behavior_mask
        )
      
        # === 拼接所有特征 ===
        concat_features = torch.cat([
            user_interest,      # 动态用户兴趣
            candidate_embed,    # 候选物品特征
            user_features       # 用户静态特征
        ], dim=-1)
      
        # === MLP 预测 ===
        output = self.output_layer(self.mlp(concat_features))
        return torch.sigmoid(output), attention_weights


# 训练示例
def train_din(model, train_loader, epochs=10):
    optimizer = torch.optim.Adam(model.parameters(), lr=0.001)
    criterion = nn.BCELoss()
  
    for epoch in range(epochs):
        for batch in train_loader:
            optimizer.zero_grad()
          
            pred, _ = model(
                user_behavior_games=batch['behavior_games'],
                user_behavior_categories=batch['behavior_categories'],
                candidate_game=batch['candidate_game'],
                candidate_category=batch['candidate_category'],
                candidate_provider=batch['candidate_provider'],
                user_features=batch['user_features'],
                behavior_mask=batch['behavior_mask']
            )
          
            loss = criterion(pred.squeeze(), batch['label'].float())
            loss.backward()
            optimizer.step()
```

### 7.5 模型融合与在线服务

```python
class RankingService:
    """
    精排服务：融合 DeepFM 和 DIN 模型
    """
  
    def __init__(self, deepfm_model, din_model, 
                 deepfm_weight=0.4, din_weight=0.6):
        self.deepfm = deepfm_model
        self.din = din_model
        self.deepfm_weight = deepfm_weight
        self.din_weight = din_weight
  
    def rank(self, user_id: str, candidate_games: List[str], 
             user_context: Dict) -> List[Tuple[str, float]]:
        """
        对候选游戏进行精排
        """
        # 1. 准备特征
        deepfm_features = self._prepare_deepfm_features(user_id, candidate_games, user_context)
        din_features = self._prepare_din_features(user_id, candidate_games, user_context)
      
        # 2. 模型推理
        with torch.no_grad():
            deepfm_scores = self.deepfm(deepfm_features).numpy()
            din_scores, attention = self.din(**din_features)
            din_scores = din_scores.numpy()
      
        # 3. 分数融合
        final_scores = (
            self.deepfm_weight * deepfm_scores + 
            self.din_weight * din_scores
        )
      
        # 4. 排序返回
        results = list(zip(candidate_games, final_scores.flatten()))
        results.sort(key=lambda x: x[1], reverse=True)
      
        return results
  
    def _get_user_behavior_sequence(self, user_id: str, max_len: int = 50):
        """获取用户行为序列（用于 DIN）"""
        # 从 Redis/DB 获取用户最近的行为序列
        behaviors = redis_client.lrange(f"user:behavior:{user_id}", 0, max_len - 1)
        return behaviors
```

---

## 8. 扩展规划（后续迭代）

### Phase 1: MVP版本（Week 1）✓

- [X] 协同过滤召回 (Item-CF)
- [X] 热门召回
- [X] DeepFM 精排
- [X] DIN 精排
- [X] 基础推荐服务

### Phase 2: 召回增强（Week 2-3）

- [ ] 双塔模型召回上线
- [ ] FAISS 向量索引
- [ ] User-CF 补充
- [ ] 召回多样性优化
- [ ] A/B 测试框架

### Phase 3: 精排优化（Week 4-5）

- [ ] DIEN (兴趣演化网络)
- [ ] 多任务学习 (MMOE/PLE)
- [ ] 特征重要性分析
- [ ] 模型蒸馏 (在线推理加速)

### Phase 4: 序列推荐（Week 6-8）

- [ ] GRU4Rec / SASRec
- [ ] MIND (多兴趣模型)
- [ ] 用户长短期兴趣建模
- [ ] 实时序列特征

### Phase 5: 全链路优化（长期）

- [ ] 多目标优化 (CTR + CVR + 时长 + 留存)
- [ ] 强化学习探索 (Bandit / RL)
- [ ] 知识图谱增强
- [ ] 实时个性化 (在线学习)
- [ ] 跨域推荐 (Sports ↔ Casino)

### 技术演进路线图

```
Week 1          Week 2-3        Week 4-5        Week 6-8        长期
   │               │               │               │              │
   ▼               ▼               ▼               ▼              ▼
┌──────┐      ┌──────┐       ┌──────┐       ┌──────┐       ┌──────┐
│Item-CF│ ──► │双塔模型│ ──► │DIEN  │ ──► │MIND  │ ──► │RL探索 │
│热门   │      │FAISS │       │多任务│       │SASRec│       │知识图谱│
│DeepFM │      │A/B   │       │蒸馏  │       │实时  │       │跨域   │
│DIN    │      │      │       │      │       │      │       │      │
└──────┘      └──────┘       └──────┘       └──────┘       └──────┘
```

---

## 9. 监控指标（增强版）

### 9.1 离线评估指标

| 指标类型           | 指标名称    | 说明               | 目标    |
| ------------------ | ----------- | ------------------ | ------- |
| **排序质量** | AUC         | 整体排序能力       | > 0.75  |
|                    | GAUC        | 分组AUC(更准确)    | > 0.70  |
|                    | NDCG@K      | 排序质量(K=10/20)  | > 0.45  |
|                    | MRR         | 平均倒数排名       | > 0.35  |
| **召回质量** | Recall@K    | 召回命中率         | > 0.60  |
|                    | HitRate@K   | 至少命中一个的比例 | > 0.85  |
| **模型性能** | LogLoss     | 预估准确性         | < 0.45  |
|                    | Calibration | 校准度(预估vs实际) | 误差<5% |

### 9.2 在线业务指标

| 指标类型             | 指标名称        | 说明                   | 目标     |
| -------------------- | --------------- | ---------------------- | -------- |
| **转化漏斗**   | 推荐CTR         | 推荐位点击率           | > 15%    |
|                      | 推荐CVR         | 推荐位转化率(开始游戏) | > 40%    |
|                      | 推荐深度        | 平均浏览推荐数量       | > 5      |
|                      | 首次转化时长    | 从进入到首次游戏的时长 | < 60s    |
| **业务效果**   | 推荐GMV占比     | 来自推荐的投注额占比   | > 30%    |
|                      | 推荐归因DAU     | 通过推荐活跃的用户数   | 持续增长 |
|                      | 人均游戏数      | 每用户平均游戏数       | > 3      |
|                      | 平均Session时长 | 用户平均停留时长       | > 10min  |
| **多样性指标** | 覆盖率          | 被推荐游戏占比         | > 80%    |
|                      | 基尼系数        | 推荐公平性(越小越均匀) | < 0.6    |
|                      | 类目覆盖        | 推荐覆盖的类目数       | > 4      |
| **新游戏指标** | 新游戏曝光率    | 新游戏推荐占比         | > 10%    |
|                      | 新游戏CTR       | 新游戏点击率           | > 10%    |
|                      | 新游戏转化率    | 新游戏开始游戏率       | > 30%    |
| **冷启动指标** | 新用户留存      | 新用户次日留存率       | > 25%    |
|                      | 新用户转化      | 新用户首日游戏率       | > 50%    |

### 9.3 系统性能指标

| 指标类型         | 指标名称    | 说明               | 目标    |
| ---------------- | ----------- | ------------------ | ------- |
| **延迟**   | P50延迟     | 中位数延迟         | < 30ms  |
|                  | P99延迟     | 99分位延迟         | < 100ms |
|                  | P999延迟    | 99.9分位延迟       | < 200ms |
| **吞吐**   | QPS         | 每秒请求数         | > 1000  |
| **可用性** | 成功率      | 请求成功率         | > 99.9% |
|                  | 降级率      | 触发降级的请求比例 | < 1%    |
| **资源**   | CPU使用率   | 服务CPU利用率      | < 70%   |
|                  | 内存使用率  | 服务内存利用率     | < 80%   |
|                  | Redis命中率 | 缓存命中率         | > 95%   |

### 9.4 监控告警规则

```
告警规则配置：
├── P0 紧急告警 (立即响应)
│   ├── 推荐服务可用性 < 99%
│   ├── P99延迟 > 500ms
│   └── 推荐CTR突然下降 > 30%
│
├── P1 重要告警 (30分钟内响应)
│   ├── P99延迟 > 200ms
│   ├── 降级率 > 5%
│   └── 覆盖率 < 70%
│
└── P2 一般告警 (当日处理)
    ├── 新游戏曝光率 < 8%
    ├── 基尼系数 > 0.7
    └── Redis命中率 < 90%
```
